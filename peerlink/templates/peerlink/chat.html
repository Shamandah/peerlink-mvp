<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat ¬∑ PeerLink ¬∑ calm conversation</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {font-family:'Inter', system-ui, sans-serif; background:#f0f4fa; padding:1.5rem; display:flex; align-items:center; justify-content:center; min-height:100vh;}
.chat-container {max-width:700px; width:100%; display:flex; flex-direction:column; height:90vh; max-height:800px;}
.header {background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border-radius:32px; padding:1.2rem 1.8rem; text-align:center; box-shadow: 0 20px 35px -12px rgba(79,70,229,0.15), 0 4px 12px rgba(0,0,0,0.05); margin-bottom:1.2rem;}
.header h2 {color:#1e293b; font-weight:500; font-size:1.6rem; letter-spacing:-0.02em; display:flex; align-items:center; justify-content:center; gap:0.4rem;}
.header h2::before {content:"üå±"; font-size:1.8rem; filter:drop-shadow(0 2px 4px rgba(79,70,229,0.2));}
.header p {color:#475569; font-size:0.95rem; background: rgba(255,255,255,0.5); padding:0.3rem 1.2rem; border-radius:40px; display:inline-block; backdrop-filter: blur(4px);}
.messages-box {background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-radius:36px; padding:2rem 1.5rem; flex:1; overflow-y:auto; box-shadow: inset 0 8px 12px -8px rgba(0,0,0,0.05), 0 20px 30px -12px rgba(0,0,0,0.1); margin-bottom:1rem; line-height:1.7; scroll-behavior: smooth; display: flex; flex-direction: column;}
.message {margin-bottom:1.2rem; animation:fadeIn 0.3s ease; display: flex; width: 100%;}
@keyframes fadeIn {0%{opacity:0; transform:translateY(4px);} 100%{opacity:1; transform:translateY(0);}}
.peer {color:#2c3e6d; background:#e6f0ff; padding:0.8rem 1.2rem; border-radius:24px 24px 24px 8px; display:inline-block; max-width:75%; box-shadow:0 4px 8px -4px rgba(0,0,0,0.05); align-self: flex-start;}
.student {color:#1e293b; background:#ffffff; padding:0.8rem 1.2rem; border-radius:24px 24px 8px 24px; display:inline-block; max-width:75%; border:1px solid #e2e8f0; align-self: flex-end; box-shadow:0 4px 8px -4px rgba(0,0,0,0.02); margin-left: auto;}
.input-area {background: rgba(255,255,255,0.85); backdrop-filter: blur(12px); border-radius:40px; padding:1.2rem 1.5rem; box-shadow: 0 20px 30px -12px rgba(79,70,229,0.2);}
.input-area form {display:flex; gap:0.8rem; align-items:center;}
.input-area input {flex:1; padding:0.9rem 1.4rem; border:1px solid #d9e2ef; border-radius:40px; font-size:1rem; outline:none; background: rgba(255,255,255,0.9); transition: all 0.2s; font-family:inherit;}
.input-area input:focus {border-color:#4f46e5; box-shadow:0 0 0 4px rgba(79,70,229,0.15); background:white;}
.input-area input::placeholder {color:#94a3b8; font-weight:300; font-style:italic;}
.input-area button {background:#4f46e5; color:white; border:none; border-radius:40px; padding:0.9rem 2rem; font-weight:500; font-size:1rem; cursor:pointer; transition: background 0.2s, transform 0.1s, box-shadow 0.2s; display:flex; align-items:center; gap:0.3rem; box-shadow:0 10px 18px -10px #4f46e5;}
.input-area button:hover {background:#4338ca; transform:scale(1.02); box-shadow:0 14px 22px -12px #4f46e5;}
.input-area button:active {transform:scale(0.98);}
.timer {text-align:center; color:#4b5f7a; font-size:0.9rem; margin-top:0.9rem; font-weight:430; background: rgba(239,246,255,0.7); padding:0.3rem 1rem; border-radius:40px; display: block; width: fit-content; margin-left:auto; margin-right:auto; backdrop-filter: blur(4px); border:1px solid rgba(255,255,255,0.7);}
.confidential-badge {display:flex; align-items:center; justify-content:center; gap:0.3rem; margin-top:0.6rem; font-size:0.75rem; color:#62748c; opacity:0.8;}
.confidential-badge svg {width:14px; height:14px; stroke:#62748c;}
</style>
</head>
<body>
<div class="chat-container">
    <div class="header">
        <h2>üí¨ Connected with a peer</h2>
        <p>You have 20 minutes ¬∑ everything is anonymous</p>
    </div>

    <div class="messages-box" id="messagesBox">
        {% if peer_greeting %}
            <div class="message"><span class="peer">{{ peer_greeting }}</span></div>
        {% endif %}

        {% for msg in messages %}
            <div class="message">
                <span class="{% if msg.sender == 'student' %}student{% else %}peer{% endif %}">
                    {{ msg.text }}
                </span>
            </div>
        {% endfor %}
        <div id="typingIndicator" class="message" style="display:none;">
            <span class="peer">üåø Peer is typing...</span>
        </div>
    </div>

    <div class="input-area">
        <form id="chatForm">
            {% csrf_token %}
            <input type="text" id="message" name="message" placeholder="type your message..." maxlength="300" required autocomplete="off">
            <button type="submit">Send ‚Üí</button>
        </form>
        <div class="timer">‚è±Ô∏è session ends in: <strong id="timeDisplay">20:00</strong></div>
        <div class="confidential-badge">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span>anonymous & confidential</span>
        </div>
    </div>
</div>

<script>
const form = document.getElementById("chatForm");
const messagesBox = document.getElementById("messagesBox");
const typingIndicator = document.getElementById("typingIndicator");

// Scroll to bottom helper
const scrollBottom = () => { messagesBox.scrollTop = messagesBox.scrollHeight; };
scrollBottom();

form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const input = document.getElementById("message");
    const text = input.value.trim();
    if (!text) return;

    // 1. Append student's message with correct class
    const studentMsg = document.createElement("div");
    studentMsg.className = "message";
    studentMsg.innerHTML = `<span class="student">${text}</span>`;
    messagesBox.insertBefore(studentMsg, typingIndicator);
    scrollBottom();
    input.value = "";

    // 2. Show typing indicator
    typingIndicator.style.display = "flex";
    scrollBottom();

    try {
        const res = await fetch("{% url 'peerlink:ask_bot' %}", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value 
            },
            body: JSON.stringify({ question: text })
        });
        
        const data = await res.json();
        
        if (data.answer) {
            const peerMsg = document.createElement("div");
            peerMsg.className = "message";
            peerMsg.innerHTML = `<span class="peer">${data.answer}</span>`;
            messagesBox.insertBefore(peerMsg, typingIndicator);
        }
    } catch (err) {
        console.error("AI error:", err);
        const errorMsg = document.createElement("div");
        errorMsg.className = "message";
        errorMsg.innerHTML = `<span class="peer">I'm so sorry, I'm having a little trouble connecting. Could you try again?</span>`;
        messagesBox.insertBefore(errorMsg, typingIndicator);
    } finally {
        typingIndicator.style.display = "none";
        scrollBottom();
    }
});

// Simple countdown timer
let time = 1200;
const timerEl = document.getElementById('timeDisplay');
setInterval(() => {
    if (time <= 0) return;
    time--;
    let m = Math.floor(time / 60);
    let s = time % 60;
    timerEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
}, 1000);
</script>
</body>
</html>